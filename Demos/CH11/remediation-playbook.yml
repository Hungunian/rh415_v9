---
###############################################################################
#
# Ansible Playbook generated from evaluation of [DRAFT] DISA STIG with GUI for Red Hat Enterprise Linux 9 [CUSTOMIZED]
#
# Profile ID: xccdf_org.ssgproject.content_profile_stig_gui_customized
# XCCDF Version:  unknown
#
# Evaluation Start Time:  2024-07-10T14:50:12-05:00
# Evaluation End Time:  2024-07-10T14:50:12-05:00
#
# This file was generated by OpenSCAP 1.3.7 using:
# $ oscap xccdf generate fix --result-id xccdf_org.open-scap_testresult_xccdf_org.ssgproject.content_profile_stig_gui_customized --fix-type ansible xccdf-results.xml
#
# This Ansible Playbook is generated from the results of a profile evaluation.
# It attempts to remediate all issues from the selected rules that failed the test.
#
# How to apply this Ansible Playbook:
# $ ansible-playbook -i "localhost," -c local playbook.yml
# $ ansible-playbook -i "192.168.1.155," playbook.yml
# $ ansible-playbook -i inventory.ini playbook.yml
#
###############################################################################


- hosts: all
  vars:
    var_accounts_password_minlen_login_defs: !!str 20
  tasks:
    - name: Find out if /etc/sudoers.d/* files contain Defaults targetpw to be deduplicated
      find:
        path: /etc/sudoers.d
        patterns: '*'
        contains: ^Defaults targetpw$
      register: sudoers_d_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove found occurrences of Defaults targetpw from /etc/sudoers.d/* files
      lineinfile:
        path: '{{ item.path }}'
        regexp: ^Defaults targetpw$
        state: absent
      with_items: '{{ sudoers_d_defaults.files }}'
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Find out if /etc/sudoers.d/* files contain Defaults rootpw to be deduplicated
      find:
        path: /etc/sudoers.d
        patterns: '*'
        contains: ^Defaults rootpw$
      register: sudoers_d_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove found occurrences of Defaults rootpw from /etc/sudoers.d/* files
      lineinfile:
        path: '{{ item.path }}'
        regexp: ^Defaults rootpw$
        state: absent
      with_items: '{{ sudoers_d_defaults.files }}'
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Find out if /etc/sudoers.d/* files contain Defaults runaspw to be deduplicated
      find:
        path: /etc/sudoers.d
        patterns: '*'
        contains: ^Defaults runaspw$
      register: sudoers_d_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove found occurrences of Defaults runaspw from /etc/sudoers.d/* files
      lineinfile:
        path: '{{ item.path }}'
        regexp: ^Defaults runaspw$
        state: absent
      with_items: '{{ sudoers_d_defaults.files }}'
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove any ocurrences of Defaults targetpw in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        regexp: ^Defaults targetpw$
        validate: /usr/sbin/visudo -cf %s
        state: absent
      register: sudoers_file_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove any ocurrences of Defaults rootpw in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        regexp: ^Defaults rootpw$
        validate: /usr/sbin/visudo -cf %s
        state: absent
      register: sudoers_file_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Remove any ocurrences of Defaults runaspw in /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        regexp: ^Defaults runaspw$
        validate: /usr/sbin/visudo -cf %s
        state: absent
      register: sudoers_file_defaults
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Check for duplicate values
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !targetpw$
        state: absent
      check_mode: true
      changed_when: false
      register: dupes
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Deduplicate values from /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !targetpw$
        state: absent
      when: dupes.found is defined and dupes.found > 1
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Insert correct line into /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !targetpw$
        line: Defaults !targetpw
        state: present
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Check for duplicate values
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !rootpw$
        state: absent
      check_mode: true
      changed_when: false
      register: dupes
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Deduplicate values from /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !rootpw$
        state: absent
      when: dupes.found is defined and dupes.found > 1
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Insert correct line into /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !rootpw$
        line: Defaults !rootpw
        state: present
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Check for duplicate values
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !runaspw$
        state: absent
      check_mode: true
      changed_when: false
      register: dupes
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Deduplicate values from /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !runaspw$
        state: absent
      when: dupes.found is defined and dupes.found > 1
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd

    - name: Insert correct line into /etc/sudoers
      lineinfile:
        path: /etc/sudoers
        create: false
        regexp: ^Defaults !runaspw$
        line: Defaults !runaspw
        state: present
      tags:
      - CCE-83529-8
      - NIST-800-53-CM-6(b)
      - NIST-800-53-CM-6.1(iv)
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sudoers_validate_passwd


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
      - CCE-83608-0
      - CJIS-5.6.2.1
      - NIST-800-171-3.5.7
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(f)
      - accounts_password_minlen_login_defs
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy



    - name: Set Password Minimum Length in login.defs
      lineinfile:
        dest: /etc/login.defs
        regexp: ^PASS_MIN_LEN *[0-9]*
        state: present
        line: PASS_MIN_LEN        {{ var_accounts_password_minlen_login_defs }}
        create: true
      when: '"shadow-utils" in ansible_facts.packages'
      tags:
      - CCE-83608-0
      - CJIS-5.6.2.1
      - NIST-800-171-3.5.7
      - NIST-800-53-CM-6(a)
      - NIST-800-53-IA-5(1)(a)
      - NIST-800-53-IA-5(f)
      - accounts_password_minlen_login_defs
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy


